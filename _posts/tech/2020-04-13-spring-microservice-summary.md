---
layout: post
title: "[MSA] 스프링 마이크로서비스 정리 (spring microservice)"
description: 스프링 마이크로서비스 책 내용 정리
author: kimchanjung
date:   2020-04-13 00:00:00 +0900
categories: tech
published: true
---

# [MSA] 스프링 마이크로서비스 정리 (spring microservice)

스프링 마이크로서비스 책 내용을 모두 요약 한 것이 아니라 개인 적으로 중요하다고 생각되는 개념만 정리 한 것임을 미리 밝혀 둡니다.  

> 마이크로 서비스의 경계 설정에 있어 만병 통치약은 없다

## 마이크로 시비스의 경계 설정
### 마이크로 서비스의 경계 설정 시 피해야 할 조건
> 마이크로 서비스간 낮은 응집도와 결합도를 유지해야한다
- 너무 많은 정보교환
- 너무 많은 동기적 요청, 응답
- 순환의존관계
- 트랜잭션 범위가 여러 마이크로 서비스에 걸치지 않게 해야함

### 적절한 마이크로 서비스 경계 설정 조건
- 자율적인 기능
  - 외부 기능에 대한 의존도가 낮다

- 배포 단위의 크기
  - 기능이 많은 서비스는 배포규모가 커진다
  - 배포단위의 크기를 감당 가능한 수준으로 유지
 
- 분리하기 적합한 기능 또는 서브도메인
  - 마이크로 서비스 전환시 자원소모량, 소유 비용, 비즈니스 유용성, 유연성 등이 분석 기준이 된다
  - 마이크로 서비스로의 분리가 유용한 선택인지, 분석기준을 통하여 판단한다
  - 검색 요청이 전체 리소스에 많은 부분을 차지하는 시스템이라면 분리시 여러가지로 유리

- 하나의 제품으로 생각을 해본다
  - 경계 지어진 마이크로 서비스가 하나의 제품으로 구성될 수 있는지의 관점에서 평가 해보자


## 동기와 비동기 선택기준
> 어느 하나의 방식만으로 시스템을 개발하는 것은 불가능, 장단점을 따져서 두방식을 적절히 조합

### 동기
- 사용자가 즉시 응답을 받아야 하는 서비스
- 마이크로 서비스간 의존성을 높이는 단점
 
### 비동기
- 즉시 응답 받지 않아도 되는 서비스
  > 이메일, 문자 발송, 포인트 서비스, 재고 갱신

## 마이크로 서비스의 과제 
### 마이크로 서비스와 대규모 데이터
> 즉 주문 마이크로 서비스와, 고객 마이크로서비스가 있다고 할 경우 고객별 주문 리스트를 가져와야할 경우에 대한 문제와 고려해 볼 방법들  
> 결론 적으로 주문 - 고객을 조인쿼리로 가져올 수 없다는 문제에 대한 해결 방법

#### 필요한 데이터를 미리 생성
- 즉 고객 별 주문 리스트를 가져오고 싶으면 각각의 마이크로 서비스에서 가져와 필요한 곳에 데이터를 생성(복제본) 해놓는 방법
- 단점은 데이터 중복문제
   > 사족을 붙이자면   
   > 이 방법 없이 조인쿼리를 사용할 수 없는 상황에서 두 마이크로 서비스의 데이터를 리스트로 가져오는 방법은 경험상 정말 비즈니스 로직이 복잡해진다. 

   > 이런 페이지들이 많다면 개발리소스도 훨씬 많이 들어가고, 어떤 경우는 특정 검색조건에 따라 리스트를 가져올 수 없는 경우도 발생한다.  

   > 내 경험상 데이터 중복 문제가 단점이라고 이 방법 없이 여러 마이크로 서비스의 데이터를 조인 없이 조인과 같은 결과를 내는 방법으로 개발을 하는 것은 정말 실수 하는 것이라고 조심스럽게 말해본다.

- 복제본 데이터를 어떻게 구성할 것인가는 마이크로 서비스를 어떻게 구성 했느냐에 따라 달라지므로 상황에 맞게 구성  
  - 통합적인 통계 관련 데이터를 제공 하는 서비스가 있다고 한다면 각 마이크로 서비스로 부터 지속적으로 데이터의 생성 변화를 입수하여 데이터 웨어하우스 같은 형태로 관리한다. 
  - 입수 방식은 이벤트 소싱(event pub/sub) 방식이 대표적, 메시지 큐 같은 여러 서비스를 활용, rabbitMQ, kafka 등등

### 의존 관계 관리
- 서비스 경계를 적절하게 설정해서 의존성을 낮춘다.
- 의존성을 가능한 느슨하게 설계해서 변경에 대한 영향을 낮춘다.
- 비동기 통신 방식을 통해 서비스간 상호작용이 일어나도록 설계.
- 서킷 브레이커 같은 패턴을 사용하여 의존성 문제의 전파를 차단.
- 의존 관계 그래프 같은 시각화를 통하여 의존 관계를 모니터링.
> 사족  
> 사실 위 조건들이 마이크로 서비스 설계시 가장 어려운 문제 인 듯 하다.  
> 모놀리식 서비스 와 마이크로 서비스, 동기와 비동기 등이 어느 한쪽을 선택하면 이익을 얻는 대신 반드시 손해를 보게되는 trade-off 관계 이기 때문이다.


